name: Build Evo X for Gale

on:
  workflow_dispatch:

jobs:
  build:
    name: Evo X Build for Gale
    runs-on: ubuntu-latest

    steps:
    - name: Checkout this repo
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y openjdk-11-jdk bc bison build-essential curl flex git gnupg gperf \
          libncurses5-dev libssl-dev libxml2 libxml2-utils lzop pngcrush repo rsync \
          schedtool squashfs-tools xsltproc zip unzip zlib1g-dev ccache git-lfs

    - name: Set Git config and add repo tool
      run: |
        git config --global user.name "Mizu111"
        git config --global user.email "mboragenah@gmail.com"
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod +x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Send Telegram Notification - Build Started
      run: |
        START_TIME=$(date +%s)
        echo "START_TIME=$START_TIME" >> $GITHUB_ENV
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TG_CHAT_ID }}" \
          -d text="üöß Starting Evo X *gale* build...\nThis may take a while ‚è≥" \
          -d parse_mode="Markdown"

    - name: Initialize Evo X repo
      run: |
        mkdir rom && cd rom
        repo init -u https://github.com/Evolution-X/manifest -b vic --git-lfs
        repo sync -c --no-tags --no-clone-bundle -j$(nproc --all)

    - name: Clone device tree, vendor, kernel
      run: |
        cd rom
        git clone https://github.com/Mayuri-Chan/android_device_xiaomi_gale.git -b dev/lineage-22.2 device/xiaomi/gale
        git clone https://github.com/Mayuri-Chan/proprietary_vendor_xiaomi_gale.git -b dev/lineage-22.2-aidl-tms vendor/xiaomi/gale
        git clone https://github.com/Mayuri-Chan/android_kernel_xiaomi_gale kernel/xiaomi/gale

    - name: Prepare for build
      run: |
        cd rom
        export ALLOW_MISSING_DEPENDENCIES=true
        export CCACHE_EXEC=$(which ccache)
        export USE_CCACHE=1
        ccache -M 50G
        source build/envsetup.sh
        lunch lineage_gale-bp1a-userdebug

    - name: Start build
      run: |
        cd rom
        m evolution -j$(nproc --all)

    - name: Upload ROM to Telegram (Success)
      if: success()
      run: |
        END_TIME=$(date +%s)
        DURATION=$(( (END_TIME - START_TIME) / 60 ))

        cd rom/out/target/product/gale
        FILE=$(ls *.zip | head -n 1)
        SIZE=$(du -h "$FILE" | cut -f1)
        MD5=$(md5sum "$FILE" | cut -d ' ' -f1)

        curl -F document=@"$FILE" \
             -F chat_id="${{ secrets.TG_CHAT_ID }}" \
             -F caption="‚úÖ *Evo X Build Complete* for *gale* üì±\n\nüì¶ File: *$FILE*\nüß© Size: *$SIZE*\nüîê MD5: \`$MD5\`\nüïí Duration: *$DURATION minutes*\n\nUploaded via GitHub Actions." \
             -F parse_mode="Markdown" \
             https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendDocument

    - name: Send Telegram Notification - Failure
      if: failure()
      run: |
        END_TIME=$(date +%s)
        DURATION=$(( (END_TIME - START_TIME) / 60 ))
        curl -s -X POST "https://api.telegram.org/bot7922883057:AAEpjI2bjh1QAOB3M2J9aJK9hv_bqGbnlAQ/sendMessage" \
          -d chat_id="5042504372" \
          -d text="‚ùå Evo X build for *gale* failed.\nüïí Duration: *$DURATION minutes*\nCheck the GitHub Actions logs." \
          -d parse_mode="Markdown"
